<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>Android要点：理解Loopers 和 Handlers | bxbxbai’s notes</title>
  <meta name="description" content="学会用不同的角度去看待和理解这个世界，你收获的永远比你想象的更多" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <meta name="generator" content="bxbxbai’s notes">

  
  
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="atom.xml">
  
  

  
</head>

<!--
<body class="post-template">
-->
<body class="home-template">
<div id="perspective" class="perspective effect-movedown">
  <div class="container">
    <!-- wrapper -->
    <div class="wrapper">

      <header class="site-head"  style="background: #24282b url(/img/img-bg.jpg) 0 -20%" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="/img/logo.svg" alt="Blog Logo"/></a> 
            <h1 class="blog-title">bxbxbai’s notes</h1>
            <h2 class="blog-description">学会用不同的角度去看待和理解这个世界，你收获的永远比你想象的更多<button id="showMenu">Show Menu</button></h2>
        </div>
    </div>
</header>

      

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2014-07-13T09:01:13.000Z" itemprop="datePublished">
          Jul 13 2014
      </time>
    
    
    | 
    <a href='/tags/Android/'>Android</a>,
    
    <a href='/tags/开发技巧/'>开发技巧</a>,
    
    <a href='/tags/翻译/'>翻译</a>
    
    
</span>
    <h1 class="post-title">Android要点：理解Loopers 和 Handlers</h1>
    <section class="post-content">
      <p>原文：<a href="http://mindtherobot.com/blog/159/android-guts-intro-to-loopers-and-handlers/" target="_blank" rel="external">http://mindtherobot.com/blog/159/android-guts-intro-to-loopers-and-handlers/</a></p>
<p>我喜欢Android的原因之一就是它有很多非常有用的小工具，其中很多还是与平台无关的。今天，我想介绍两个非常nice 的类——<code>Looper</code>和<code>Handler</code>，他们用于Android UI，并且对我们开发者也可用，我们就可以用它们来做很多非常棒的事情了。</p>
<a id="more"></a>
<p>那么，我们能用<code>Looper</code>和<code>Handler</code>做什么呢？首先，这两个类实现了一种通用的并发模型，我把它叫做：Pipeline 线程。它是这样工作的：</p>
<ol>
<li>Pipeline 线程持有一个任务队列（a queue of tasks），这些任务就是一些可以执行的工作单元（units of work）</li>
<li>其他线程可以自由的将任务加到Pipeline线程的任务队列中去</li>
<li>Pipeline线程就按次序一个一个执行任务，如果任务队列中没有任务了，它就会自动阻塞直到有任务到来</li>
<li>有些时候，任务可以叫做消息（messages）或者其他名字</li>
</ol>
<p>这个架构有一些很好的特征，并且这个架构已经被用于其他平台的框架或应用中了。</p>
<p>这篇文章中，我们会新建一个简单的app来模拟一个下载任务队列，同时在UI界面显示任务的状态，我们就直接使用Looper和Handler了。（源代码可以去原文中下载）</p>
<p>但是，我们在开始前先来看一下Pipeline线程，以及Looper和Handler的原理。</p>
<p>###Pipeline线程的用途<br>Pipeline线程的用途可以在几乎所有的UI框架中找到，包括Swing，SWT，Adobe Flex，以及Android Activity。Pipeline线程模式经常被用于处理UI事件（如按钮的点击事件，手指移动，屏幕方向改变，屏幕重新绘制等等），它可以让你在改变一个按钮文字的时候同时不用担心用户会点击这个按钮（译者注：这两个事件不会并发执行，处理UI事件是单线程的）。</p>
<p>另一方面，这就迫使你在UI线程中执行较快的操作——任何一个开发都知道如果你在一个按钮的<code>OnClick</code>方法中去下载一个文件会发生什么事情。</p>
<p>其他Pipeline线程模式的通用操作有：</p>
<ol>
<li>执行一个到远程服务的request（通常你希望它们一个一个按序执行） </li>
<li>上传一个图片到http服务器</li>
<li>缩放以及剪裁图片</li>
<li>下载操作</li>
</ol>
<p>通常，使用一个Pipeline线程而不是为每个后台操作都新建一个线程的好处就是，这样你可以控制每个后台任务的加载以及顺序（优先级）。此外，你也可以开启多个Pipeline线程，把他们当做一个线程池，这样你就可以一次同时执行多个操作。</p>
<p>###Looping和Handling<br><a href="http://developer.android.com/reference/android/os/Looper.html" target="_blank" rel="external">Looper</a>类可以将一个线程转换成Pipeline线程，而<a href="http://developer.android.com/reference/android/os/Handler.html" target="_blank" rel="external">Handler</a>提供了一种机制，你可以通过它将任务添加到Pipeline线程中。Looper之所以这么命名是因为它实现了循环——取一个task执行，然后再取下一个task执行，如此循环；Handler如此命名是因为他们无法想出一个更好的名字了~（译者注：囧…）</p>
<p>下面就是你需要添加到Thread类的run方法中的代码来创建一个你自己的Pipeline线程，然后可以将这个Pipeline线程添加到Handler对象中：</p>
<pre><code><span class="annotation">@Override</span>
<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{
  <span class="keyword">try</span> {
    <span class="comment">// preparing a looper on current thread     </span>
    <span class="comment">// the current thread is being detected implicitly</span>
    Looper.prepare();

    <span class="comment">// now, the handler will automatically bind to the</span>
    <span class="comment">// Looper that is attached to the current thread</span>
    <span class="comment">// You don't need to specify the Looper explicitly</span>
    <span class="keyword">handler</span> = <span class="keyword">new</span> Handler();

    <span class="comment">// After the following line the thread will start</span>
    <span class="comment">// running the message loop and will not normally</span>
    <span class="comment">// exit the loop unless a problem happens or you</span>
    <span class="comment">// quit() the looper (see below)</span>
    Looper.loop();
  } <span class="keyword">catch</span> (Throwable t) {
    Log.e(TAG, <span class="string">"halted due to an error"</span>, t);
  } 
}
</code></pre><p>然后，你只要将这个handler对象传到其他任何线程中去，它有一个线程安全的接口，包括了很多操作，但是最主要的操作就是<code>postMessage()</code>以及相关的方法了。</p>
<p>#####Notes：Handler类包含了很多非常棒的方法，特别是与消息传递有关的，本文不会写与此相关的内容。</p>
<p>举个栗子：想象一下，一个线程A持有了handler对象的引用，此handler是在Pipeline线程中创建的，下面代码就可以让这个线程A在Pipeline线程中执行操作了：</p>
<pre><code><span class="keyword">handler</span>.post(<span class="keyword">new</span> Runnable() {
  <span class="annotation">@Override</span>
  <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{       
    <span class="comment">// this will be done in the Pipeline Thread       </span>
  }
});
</code></pre><p>在下载的栗子中，我们就会在用户点击按钮（在UI线程中处理）的时候，用这个模板来创建一个下载任务（在下载Pipeline线程中）。我们还用另外一种方式用它——当下载线程下载完成以后会通知Activity，因此在创建下载线程的时候，我们会将Activity中的UI线程handler对象传给它。</p>
<p>此外，UI线程拥有一个Looper（译者注：可以通过Looper.getMainLooper()方法获取，判断一个线程是否为主线程可以使用Looper.getLooper() == Looper.getMainLooper()来判断）。所以，你可以在Activity的onCreate()方法中直接新建一个handler对象：</p>
<pre><code><span class="annotation">@Override</span>
<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>{
    <span class="keyword">super</span>.onCreate(savedInstanceState);
    setContentView(R.layout.main);

    <span class="comment">// Create the Handler. It will implicitly bind to the Looper</span>
    <span class="comment">// that is internally created for this thread (since it is the UI thread)</span>
    <span class="keyword">handler</span> = <span class="keyword">new</span> Handler();
}
</code></pre><p>###结论<br>Looper和Handler可以让你很方便的做很多事情，然而他们与并发相关，这就会变得很复杂。</p>
<p>####译者注：<br>Looper和Handler是非UI线程更新界面的重要方式，在非UI线程中通过下面代码：</p>
<pre><code><span class="keyword">new</span> Handler(Looper.myLooper()).post(<span class="keyword">new</span> Runnable() {
    <span class="annotation">@Override</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{
        <span class="comment">//在UI线程中处理 </span>
    }
});
</code></pre><p>就可以轻松的将一些工作放到UI线程中处理，比如进度条刷新等等。</p>
<p>####附件：<a href="http://mindtherobot.com/blog/wp-content/uploads/2010/06/downloadqueue.zip" target="_blank" rel="external">完整源代码</a></p>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>bxbxbai</h4>
    <p>杭州人，目前上海工作，Android码农，不断学习中，这里主要记录我的技术学习和感悟</p>
</section>
      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-sina-weibo" href="http://v.t.sina.com.cn/share/share.php?title=杭州人，目前上海工作，Android码农，不断学习中，这里主要记录我的技术学习和感悟 ?url=http://bxbxbai.gitcafe.io/2014/07/13/android要点理解looper和handler/" target="_blank">
        <span class="hidden">weibo</span>
    </a>
    <a class="icon-twitter" href="http://twitter.com/share?url=http://bxbxbai.gitcafe.io/2014/07/13/android要点理解looper和handler/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://bxbxbai.gitcafe.io/2014/07/13/android要点理解looper和handler/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://bxbxbai.gitcafe.io/2014/07/13/android要点理解looper和handler/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>

    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/2014/07/16/context/">
        ← Context，什么是Context？
    </a>
    
    <span class="icon-logo">•</span>
    
    <a class="older-posts" href="/2014/06/11/防御性编程以及我的一些感想/">
        防御性编程以及我的一些感想 →
    </a>
    
</nav>

  <div id="comment" class="comments-area">
    <h4 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h4>
    
</div>

</main>


      
<footer class="site-footer">
  
  <a class="subscribe icon-feed" href="atom.xml"><span class="tooltip">Subscribe!</span></a>
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">bxbxbai’s notes</a> &copy; 2014 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

      <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>
<script type="text/javascript" src="/js/menu.js"></script>





  </div>
</div>

<nav  class="outer-nav top horizontal">

          <a class="icon-home"  href="/"><span>Home</span></a>

          <a class="icon-news"  href="/archive"><span>Archive</span></a>

          <a class="default"  href="/about/"><span>About</span></a>

</nav>

</div>
</body>
</html>
